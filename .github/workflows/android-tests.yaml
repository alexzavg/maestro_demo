name: Android Tests

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Maestro CLI
        shell: bash
        run: |
          set -e
          for i in {1..5}; do
            if curl -fsSL https://get.maestro.mobile.dev | bash; then
              break
            fi
            echo "Maestro install failed (attempt $i), retrying in 10s..."
            sleep 10
          done
          export PATH="$HOME/.maestro/bin:$PATH"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Verify Maestro
        run: maestro --version

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK packages
        shell: bash
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager --install \
            'platform-tools' \
            'emulator' \
            'platforms;android-34' \
            'system-images;android-34;google_apis;x86_64'

      - name: Start Android emulator (manual)
        shell: bash
        env:
          AVD_NAME: Maestro_Pixel_6_API_34
        run: |
          adb kill-server || true
          adb start-server

          echo no | avdmanager create avd -n "$AVD_NAME" \
            -k "system-images;android-34;google_apis;x86_64" \
            --device "pixel_6" \
            --force

          "$ANDROID_SDK_ROOT/emulator/emulator" -avd "$AVD_NAME" \
            -no-window -gpu host -no-snapshot -noaudio -no-boot-anim -camera-back none -camera-front none -wipe-data \
            > /dev/null 2>&1 &

          adb wait-for-device
          for i in $(seq 1 120); do
            STATE="$(adb get-state 2>/dev/null || true)"
            BOOT="$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || true)"
            echo "ADB STATE=$STATE BOOT=$BOOT"
            if [ "$STATE" = "device" ] && [ "$BOOT" = "1" ]; then
              break
            fi
            adb reconnect || true
            sleep 5
          done

          if [ "$(adb get-state 2>/dev/null || true)" != "device" ]; then
            echo "Device did not come online" >&2
            exit 1
          fi

          adb shell input keyevent 82 || true

      - name: Install APK and run Maestro tests
        shell: bash
        run: |
          npm run android:install:wikipedia
          maestro test .maestro/flows \
            --config .maestro/configs/wikipedia.config.yaml \
            -e appId=org.wikipedia \
            --format html \
            --output test-results/wikipedia.html

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-wikipedia-report
          path: test-results
